#!/bin/bash

# TODO: Accept only date or only time
#
# TODO(feat): Add support for formatting:
#   <t:unix_timestamp:t> - short time (e.g. 9:41 PM).
#   <t:unix_timestamp:T> - long time (e.g. 9:41:30 PM).
#   <t:unix_timestamp:d> - short date (e.g. 01/29/2026).
#   <t:unix_timestamp:D> - long date (e.g. 29 January 2026).
#   <t:unix_timestamp:f> - short date + time (e.g. `29 January 2026 9:41 PM`).
#   <t:unix_timestamp:F> - full date + weekday + time.
#   <t:unix_timestamp:R> - relative time (e.g. `in 2 hours`, `3 days ago`).


declare DATE
declare TIME
declare INPUT
declare FORMAT
# CURRENT_DATE=$(date '+%F %R')
CURRENT_DATE=$(date '+%Y-%m-%d %H:%M')  # POSIX-friendly

printf "Current date: %s\n" "$CURRENT_DATE"

usage(){
    cat <<- EOF
	Usage: 
	    discord-timestamp [OPTIONS] DATE TIME

	Options: 
	    -h, --help
	        Display this help text and exit.

	    -f, --format <CODE>
	        Displays the UNIX timestamp with the format code provided at the end.
	        Available codes:

	        Code	Format
	        t	    Short time (9:00 AM)
	        T	    Long time (9:00:00 AM)
	        d	    Short date (08/09/2024)
	        D	    Long date (August 9, 2024)
	        f	    Short date/time (August 9, 2024 9:00 AM)
	        F	    Long date/time (Friday, August 9, 2024 9:00 AM)
	        R	    Relative (in 2 days)
	EOF

}

while [[ -n $1 && $1 =~ ^- && ! $1 == '--' ]]; do
    case $1 in
        -h|--help)
            usage
            exit 0;
            ;;

        -f|--format)
            if [[ -n $2 && ! $2 =~ ^- ]]; then
                shift
                if ! [[ $1 =~ ^[ftdFTDR]$ ]]; then
                    printf "Usage: -f | --format [f|t|d|D|f|F|R]\n"
                    printf "See --help for list of options and what they look like.\n"
                    exit 1;
                fi
                FORMAT=$1
            else
                printf >&2 "Invalid or missing argument to -f|--format! Exiting.\n" 
                exit 1;
            fi
            shift;
            ;;

        *)
            printf "Unknown argument: %s\n" "$1"
            usage
            exit 1
            ;;
    esac
done

[[ $1 == '--' ]] && shift;

[[ -n $1 && -n $2 ]] &&
    DATE=$1 && TIME=$2 &&
    INPUT=$(perl -pe 's/([-\d]+)\s+([:\d]+).*/\1 \2/' <<< "$DATE $TIME")
        # perl -p -e 's/(\d{4}-\d{2}-\d{2}) (\d{2}:\d{2}).*/\1 \2/');

[[ -z $INPUT ]] &&
    printf "No input provided. Using the current date/time (%s).\n" "${INPUT:=$CURRENT_DATE}"

printf "Calculating Discord timestamp for: %s\n" "${INPUT}"

EPOCH=$(date -d "${INPUT}" +%s 2>/dev/null)
[[ -z $EPOCH ]] && {
    printf "Failed to calculate the epoch time for the given date.\n"
    exit 1
}

printf "<t:%s:%s>\n" "${EPOCH}" "${FORMAT:-f}"

