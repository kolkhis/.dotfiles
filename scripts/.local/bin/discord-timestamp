#!/bin/bash
# TODO: Accept only date or only time, default to current date/time

declare DATE
declare TIME
declare INPUT
declare FORMAT
# CURRENT_DATE=$(date '+%F %R')
declare CURRENT_DATE
CURRENT_DATE=$(date '+%Y-%m-%d %H:%M')  # POSIX-friendly

usage(){
    cat <<- EOF
	Usage: 
	    discord-timestamp [OPTIONS] DATE TIME

        DATE must be formatted as YYYY-MM-DD  
        TIME must be formatted as HH:MM  

	Options: 
	    -h, --help
	        Display this help text and exit.

	    -f, --format <CODE>
	        Displays the UNIX timestamp with the format code provided at the end.
	        Available codes:
                Code	Format
                t	    Short time (9:00 AM)
                T	    Long time (9:00:00 AM)
                d	    Short date (08/09/2024)
                D	    Long date (August 9, 2024)
                f	    Short date/time (August 9, 2024 9:00 AM)
                F	    Long date/time (Friday, August 9, 2024 9:00 AM)
                R	    Relative (in 2 days)
    Notes:
        Note that [OPTIONS] must come before the date and time.  
	EOF

}

while [[ -n $1 && $1 =~ ^- && ! $1 == '--' ]]; do
    case $1 in
        -h|--help)
            usage
            exit 0;
            ;;

        -f|--format)
            if [[ -n $2 && ! $2 =~ ^- ]]; then
                shift
                if ! [[ $1 =~ ^[ftdFTDR]$ ]]; then
                    printf "Usage: -f | --format [f|t|d|D|f|F|R]\n"
                    printf "See --help for list of options and what they look like.\n"
                    exit 1;
                fi
                FORMAT="$1"
            else
                printf >&2 "Invalid or missing argument to -f|--format! Exiting.\n" 
                exit 1;
            fi
            shift;
            ;;

        *)
            printf "Unknown argument: %s\n" "$1"
            usage
            exit 1
            ;;
    esac
done

[[ $1 == '--' ]] && shift;

if [[ -n $1 && -n $2 ]]; then
    DATE="$1" && TIME="$2" &&
    INPUT="$(perl -pe 's/([-\d]+)\s+([:\d]+).*/\1 \2/' <<< "$DATE $TIME")"
else
    printf >&2 '[ERROR]: Could not determine date and time. Did you put the options after the date?\n'
    exit 1
fi

if [[ -z $INPUT ]]; then
    printf "[ERROR]: No input provided. Using the current date/time (%s).\n" "${INPUT:=$CURRENT_DATE}"
    usage
    exit 1
fi

# printf "Calculating Discord timestamp for: %s\n" "${INPUT}"

EPOCH="$(date -d "${INPUT}" +%s 2>/dev/null)"
[[ -z $EPOCH ]] && {
    printf "[ERROR]: Failed to calculate the epoch time for the given date.\n"
    printf "[ERROR]: Does the given date (%s) exist?\n" "${DATE}/${TIME}"
    usage
    exit 1
}

# Output timestamp
printf "<t:%s:%s>\n" "${EPOCH}" "${FORMAT:-f}"



